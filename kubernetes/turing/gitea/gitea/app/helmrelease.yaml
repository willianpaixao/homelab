---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &name gitea
  namespace: &namespace gitea
spec:
  interval: 1h
  timeout: 15m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    defaultPodOptions:
      labels:
        app: gitea
        environment: production
        owner: willianpaixao
      enableServiceLinks: false
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
    controllers:
      gitea:
        pod:
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            fsGroupChangePolicy: "OnRootMismatch"
        containers:
          gitea:
            image:
              repository: ghcr.io/go-gitea/gitea
              tag: 1.25.4-rootless@sha256:1926e89ad28358ef2146bb8a1b9c3ba24bae681cb02b72d2df11125fdc675abe
            env:
              TZ: "${TIMEZONE}"
              USER_UID: 1000
              USER_GID: 1000
              GITEA__database__DB_TYPE: sqlite3
              GITEA__database__PATH: /var/lib/gitea/gitea.db
              GITEA__REPOSITORY__ENABLE_PUSH_CREATE_USER: "true"
              GITEA__SECURITY__INSTALL_LOCK: "true"
              GITEA__SERVER__DOMAIN: "gitea.${SECRET_DOMAIN}"
              GITEA__SERVER__ROOT_URL: "https://gitea.${SECRET_DOMAIN}"
              GITEA__SERVER__SSH_DOMAIN: "git.${SECRET_DOMAIN}"
              GITEA__SERVER__SSH_PORT: 22
              GITEA__SERVER__START_SSH_SERVER: "true"
              GITEA__SERVER__SSH_LISTEN_PORT: 2222
            probes:
              liveness: &probes
                enabled: true
              readiness: *probes
              startup: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                add:
                  - CHOWN
                drop:
                  - ALL
            resources:
              requests:
                cpu: 500m
                memory: 256Mi
      runner:
        pod:
          securityContext:
            fsGroup: 1000
        containers:
          runner:
            image:
              repository: gitea/act_runner
              tag: latest@sha256:8477d5b61b655caad4449888bae39f1f34bebd27db56cb15a62dccb3dcf3a944
            env:
              TZ: "${TIMEZONE}"
              GITEA_INSTANCE_URL: "http://gitea.gitea.svc.cluster.local:3000"
              GITEA_RUNNER_NAME: "turing-k8s"
              GITEA_RUNNER_LABELS: "ubuntu-latest:docker://gitea/runner-images:ubuntu-latest,ubuntu-24.04:docker://gitea/runner-images:ubuntu-24.04,ubuntu-20.04:docker://gitea/runner-images:ubuntu-20.04"
              DOCKER_HOST: "tcp://localhost:2376"
              DOCKER_TLS_VERIFY: "1"
              DOCKER_CERT_PATH: "/certs/client"
            envFrom:
              - secretRef:
                  name: gitea-runner-secret
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                memory: 4Gi
          dind:
            image:
              repository: docker
              tag: 29-dind@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
            env:
              TZ: "${TIMEZONE}"
              DOCKER_TLS_CERTDIR: "/certs"
            securityContext:
              runAsUser: 0
              runAsNonRoot: false
              privileged: true
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                memory: 512Mi
    ingress:
      gitea:
        className: internal
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/group: Gitea
          gethomepage.dev/icon: gitea.png
          gethomepage.dev/name: Gitea
        hosts:
          - host: &host gitea.${SECRET_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: gitea
                  port: http
        tls:
          - hosts:
              - *host
    service:
      gitea:
        controller: *name
        ports:
          http:
            port: 3000
      ssh:
        controller: *name
        type: LoadBalancer
        loadBalancerIP: 192.168.0.167
        annotations:
          external-dns.alpha.kubernetes.io/hostname: "git.${SECRET_DOMAIN}"
        ports:
          ssh:
            port: 22
            targetPort: 2222
            protocol: TCP
    persistence:
      config:
        type: persistentVolumeClaim
        accessMode: ReadWriteOnce
        size: 16Gi
        globalMounts:
          - path: /var/lib/gitea
      tmp:
        type: emptyDir
        globalMounts:
          - path: /tmp
      runner-data:
        type: emptyDir
        advancedMounts:
          runner:
            runner:
              - path: /data
      runner-cache:
        type: emptyDir
        advancedMounts:
          runner:
            runner:
              - path: /cache
      docker-certs:
        type: emptyDir
        advancedMounts:
          runner:
            runner:
              - path: /certs/client
                readOnly: true
            dind:
              - path: /certs/client
      dind-storage:
        type: emptyDir
        advancedMounts:
          runner:
            dind:
              - path: /var/lib/docker
