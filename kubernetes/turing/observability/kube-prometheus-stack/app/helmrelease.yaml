---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app prometheus-agent
  namespace: &namespace observability
spec:
  interval: 1h
  timeout: 15m
  chartRef:
    kind: OCIRepository
    name: kube-prometheus-stack
    namespace: flux-system
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    alertmanager:
      enabled: false
    grafana:
      enabled: false
    kubeEtcd:
      enabled: false
    kubeControllerManager:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeProxy:
      enabled: false
    kubelet:
      enabled: true
      serviceMonitor:
        # Increase scrape timeout to handle slower responses
        scrapeTimeout: 10s
        metricRelabelings:
          # Drop high cardinality labels
          - action: labeldrop
            regex: (uid)
          - action: labeldrop
            regex: (id|name)
          # Drop high cardinality metrics that often cause out-of-order issues
          - action: drop
            sourceLabels: ["__name__"]
            regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)
          # Optionally drop some cAdvisor metrics prone to timestamp issues
          - action: drop
            sourceLabels: ["__name__"]
            regex: (container_memory_failures_total)
    prometheus:
      agentMode: true
      prometheusSpec:
        externalLabels:
          cluster: "turing"
        scrapeInterval: 30s
        podMonitorSelectorNilUsesHelmValues: false
        scrapeConfigSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false
        # Enable out-of-order time series ingestion
        enableFeatures:
          - out-of-order-time-series
        # Allow samples up to 5 minutes out of order
        # This handles kubelet/cAdvisor timestamp inconsistencies
        # without significantly impacting performance
        tsdb:
          outOfOrderTimeWindow: 5m
        remoteWrite:
          - url: 'http://192.168.0.35:9090/api/v1/write'
