---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app prometheus-agent
  namespace: &namespace observability
spec:
  interval: 1h
  timeout: 15m
  chartRef:
    kind: OCIRepository
    name: kube-prometheus-stack
    namespace: flux-system
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    alertmanager:
      enabled: false
    grafana:
      enabled: false
    kubeEtcd:
      enabled: false
    kubeControllerManager:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeProxy:
      enabled: false
    kubelet:
      enabled: true
      serviceMonitor:
        # Disable honorTimestamps to prevent duplicate sample errors
        honorTimestamps: false
        # Disable trackTimestampsStaleness - when true, it forces honorTimestamps: true for cAdvisor
        trackTimestampsStaleness: false
        # Increase scrape timeout to handle slower responses
        scrapeTimeout: 10s
        metricRelabelings:
          # Drop high cardinality labels that cause duplicates
          - action: labeldrop
            regex: (uid)
          - action: labeldrop
            regex: (id|name)
          # Drop high cardinality metrics that often cause out-of-order issues
          - action: drop
            sourceLabels: ["__name__"]
            regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)
          # Drop metrics prone to timestamp issues
          - action: drop
            sourceLabels: ["__name__"]
            regex: (container_memory_failures_total)
          # Drop expensive histogram buckets
          - action: drop
            sourceLabels: ["__name__"]
            regex: (apiserver_request_duration_seconds_bucket|apiserver_response_sizes_bucket)
        # cAdvisor-specific metric relabelings
        cAdvisorMetricRelabelings:
          # Drop high cardinality labels
          - action: labeldrop
            regex: (uid)
          - action: labeldrop
            regex: (id|name)
          # Drop all histogram buckets from cAdvisor (very high cardinality)
          - sourceLabels: ["__name__"]
            regex: container_.*_bucket
            action: drop
          # Drop metrics for non-pod containers (system slices)
          - sourceLabels: [id, pod]
            regex: .+;
            action: drop
          # Drop rarely used high-cardinality metrics
          - sourceLabels: ["__name__"]
            regex: (container_tasks_state|container_memory_failures_total|container_blkio.*|container_file_descriptors|container_sockets|container_threads|container_threads_max|container_ulimits_soft|container_spec_.*)
            action: drop
          # Drop duplicate cpu metrics that overlap with kubelet
          - sourceLabels: ["__name__"]
            regex: (container_cpu_cfs_periods_total|container_cpu_cfs_throttled_periods_total|container_cpu_cfs_throttled_seconds_total)
            action: drop
    prometheus:
      agentMode: true
      prometheusSpec:
        externalLabels:
          cluster: "turing"
        scrapeInterval: 30s
        podMonitorSelectorNilUsesHelmValues: false
        scrapeConfigSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false
        # Enable out-of-order time series ingestion
        enableFeatures:
          - out-of-order-time-series
        # Allow samples up to 5 minutes out of order
        # This handles kubelet/cAdvisor timestamp inconsistencies
        # without significantly impacting performance
        tsdb:
          outOfOrderTimeWindow: 5m
        # Global metric relabeling to reduce cardinality before remote write
        metricRelabelConfigs:
          # Drop high-cardinality API server histogram buckets
          - sourceLabels: ["__name__"]
            regex: (apiserver_request_duration_seconds_bucket|apiserver_response_sizes_bucket|apiserver_watch_events_sizes_bucket)
            action: drop
          # Drop high-cardinality workqueue metrics
          - sourceLabels: ["__name__"]
            regex: (workqueue_queue_duration_seconds_bucket|workqueue_work_duration_seconds_bucket)
            action: drop
          # Drop etcd histogram buckets
          - sourceLabels: ["__name__"]
            regex: (etcd_request_duration_seconds_bucket|etcd_disk_wal_fsync_duration_seconds_bucket|etcd_disk_backend_commit_duration_seconds_bucket)
            action: drop
          # Drop go runtime metrics with high cardinality
          - sourceLabels: ["__name__"]
            regex: (go_gc_.*|go_memstats_.*_bytes_total)
            action: drop
        remoteWrite:
          - url: 'http://192.168.0.35:9090/api/v1/write'
