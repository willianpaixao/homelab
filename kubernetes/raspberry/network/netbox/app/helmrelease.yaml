---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app netbox
  namespace: network
spec:
  interval: 1h
  timeout: 15m
  chartRef:
    kind: OCIRepository
    name: netbox
  values:
    podAnnotations:
      reloader.stakater.com/auto: "true"
    image:
      repository: ghcr.io/netbox-community/netbox
      tag: v4.5.0@sha256:95f3c9ff3ce5a55cd102be29c45a96797152098266f7436d4f871cd8f3e7d2c6
    resources:
      requests:
        cpu: 1
        memory: 1Gi
      limits:
        cpu: 2
        memory: 1Gi
    replicaCount: 1
    resourcesPreset: "none"
    loginRequired: true
    timeZone: ${TIMEZONE}
    metrics:
      enabled: true
    redis:
      enabled: true
      architecture: standalone
      master:
        persistence:
          enabled: false
    postgresql:
      primary:
        nodeSelector:
          disktype: ssd
    housekeeping:
      enabled: false
    worker:
      enabled: false
    livenessProbe:
      enabled: false
    readinessProbe:
      enabled: false
    startupProbe:
      enabled: false

    ingress:
      enabled: true
      className: internal
      hosts:
        - host: &host netbox.${SECRET_DOMAIN}
          paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: netbox
                  port:
                    number: 80
      tls:
        - hosts:
            - *host
