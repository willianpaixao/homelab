---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager-config
  namespace: observability
  labels:
    alertmanagerConfig: kube-prometheus-stack
spec:
  route:
    groupBy: ['alertname']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 12h
    receiver: 'telegram'
    routes:
      - receiver: 'null'
        matchers:
          - name: 'alertname'
            value: 'InfoInhibitor|NodeCPUHighUsage|NodeSystemSaturation'
            matchType: '=~'
      - receiver: 'dead-mans-switch'
        groupWait: 0s
        groupInterval: 5m
        repeatInterval: 5m
        matchers:
          - name: 'alertname'
            value: 'Watchdog'
            matchType: '='
      - receiver: 'telegram'
        matchers:
          - name: 'severity'
            value: 'critical|page'
            matchType: '=~'
  receivers:
    - name: 'null'
    - name: 'dead-mans-switch'
      webhookConfigs:
        - url: "${HEALTHCHECKS_IO_URL}"
    - name: 'telegram'
      telegramConfigs:
        - botToken:
            name: 'telegram-config'
            key: 'BOT_TOKEN'
          chatID: "${TELEGRAM_CHAT_ID}"
          parseMode: HTML
          sendResolved: true
          message: |-
            {{ range .Alerts }}
            {{- if eq .Status "firing" }}
            ğŸ”¥ <b>ALERT FIRING</b> ğŸ”¥
            {{- else }}
            âœ… <b>ALERT RESOLVED</b> âœ…
            {{- end }}

            ğŸªª <b>{{ .Labels.alertname }}</b>
            {{- if .Labels.severity }}
            {{- if eq .Labels.severity "critical" }}
            ğŸš¨ <b>Severity:</b> CRITICAL
            {{- else if eq .Labels.severity "warning" }}
            âš ï¸ <b>Severity:</b> WARNING
            {{- else if eq .Labels.severity "info" }}
            â„¹ï¸ <b>Severity:</b> INFO
            {{- else }}
            â„¹ï¸ <b>Severity:</b> {{ .Labels.severity | toUpper }}
            {{- end }}
            {{- end }}
            {{- if .Labels.cluster }}
            ğŸ·ï¸ <b>Cluster:</b> <code>{{ .Labels.cluster }}</code>
            {{- end }}

            {{- if .Annotations.summary }}
            ğŸ“ <b>Summary:</b>
            {{ .Annotations.summary }}
            {{- end }}

            {{- if .Annotations.description }}
            ğŸ“– <b>Description:</b>
            {{ .Annotations.description }}
            {{- end }}

            {{- if .Labels.namespace }}
            ğŸ“¦ <b>Namespace:</b> <code>{{ .Labels.namespace }}</code>
            {{- end }}

            {{- if .Labels.pod }}
            ğŸ³ <b>Pod:</b> <code>{{ .Labels.pod }}</code>
            {{- end }}

            {{- if .Labels.container }}
            ğŸ“¦ <b>Container:</b> <code>{{ .Labels.container }}</code>
            {{- end }}

            {{- if .Labels.pvc }}
            ğŸ’¾ <b>PVC:</b> <code>{{ .Labels.pvc }}</code>
            {{- if .Labels.pvc_namespace }}
             (ns: <code>{{ .Labels.pvc_namespace }}</code>)
            {{- end }}
            {{- end }}

            {{- if .Labels.node }}
            ğŸ–¥ï¸ <b>Node:</b> <code>{{ .Labels.node }}</code>
            {{- end }}

            {{- if .Labels.job }}
            ğŸ’¼ <b>Job:</b> <code>{{ .Labels.job }}</code>
            {{- end }}

            {{- if .Labels.instance }}
            ğŸŒ <b>Instance:</b> <code>{{ .Labels.instance }}</code>
            {{- end }}

            {{- if .Annotations.runbook_url }}
            ğŸ“š <b>Runbook:</b> <a href="{{ .Annotations.runbook_url }}">View</a>
            {{- end }}

            ğŸ• <b>Started:</b> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
            {{- if eq .Status "resolved" }}
            ğŸ•‘ <b>Ended:</b> {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}
            {{- end }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            {{ end }}
